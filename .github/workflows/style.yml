---
name: Style
on:
  push:
    branches: ['**']
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sunday night at 6 AM UTC to catch any formatting drift
    - cron: 0 6 * * 0
jobs:
  format-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11.2
      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Install formatting dependencies
        run: |
          pip install -r utils/requirements_format.txt
      - name: Check current formatting
        id: format-check
        run: |
          cd utils
          if python format.py --show-errors; then
            echo "formatted=true" >> $GITHUB_OUTPUT
            echo "Repository is correctly formatted"
          else
            echo "formatted=false" >> $GITHUB_OUTPUT
            echo "Repository needs formatting"
          fi
      - name: Apply formatting fixes
        if: steps.format-check.outputs.formatted == 'false'
        run: |
          cd utils
          python format.py --fix --show-errors
      - name: Check for changes after formatting
        if: steps.format-check.outputs.formatted == 'false'
        id: git-check
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes were made by the formatter"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Formatting changes were made"
          fi
      - name: Handle main branch formatting
        if: |
          steps.format-check.outputs.formatted == 'false' &&
          steps.git-check.outputs.changes == 'true' &&
          github.ref == 'refs/heads/main'
        run: |
          # Create a new branch for the formatting PR
          BRANCH_NAME="auto-format-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"

          # Add and commit changes
          git add .
          git commit -m "Style: auto-format code with format.py
          - Applied yapf formatting to Python files
          - Applied beautysh formatting to shell scripts
          - Applied mdformat formatting to Markdown files
          - Applied yamllint formatting to YAML files
          This commit was automatically generated by the formatting workflow."

          # Push the branch
          git push origin "$BRANCH_NAME"

          # Create pull request using GitHub CLI
          echo "Creating pull request for formatting changes..."
          gh pr create \
            --title "üé® Auto-format code" \
            --body "This PR was automatically created to fix code formatting issues detected on the main branch.

          ## Changes Made
          - Applied consistent formatting using \`format.py\`
          - Python files formatted with yapf
          - Shell scripts formatted with beautysh
          - Markdown files formatted with mdformat
          - YAML files formatted with yamllint

          ## Review Notes
          - This is an automated formatting fix
          - All changes are purely stylistic
          - No functional changes have been made
          Please review and merge if the formatting looks correct." \
            --head "$BRANCH_NAME" \
            --base main \
            --label "formatting" \
            --label "automated"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Handle non-main branch formatting
        if: |
          steps.format-check.outputs.formatted == 'false' &&
          steps.git-check.outputs.changes == 'true' &&
          github.ref != 'refs/heads/main'
        run: |
          # Add and commit changes directly to the current branch
          git add .
          git commit -m "Style: auto-format code with format.py
          - Applied yapf formatting to Python files
          - Applied beautysh formatting to shell scripts
          - Applied mdformat formatting to Markdown files
          - Applied yamllint formatting to YAML files
          This commit was automatically generated by the formatting workflow."

          # Push changes to the current branch
          git push origin HEAD
      - name: Report formatting status
        if: steps.format-check.outputs.formatted == 'true'
        run: |
          echo "‚úÖ Repository is correctly formatted - no action needed"
      - name: Report no changes needed
        if: |
          steps.format-check.outputs.formatted == 'false' &&
          steps.git-check.outputs.changes == 'false'
        run: |
          echo "‚ö†Ô∏è Format check failed but no changes were made by formatter"
          echo "This might indicate an issue with the formatting configuration"
      - name: Summary
        if: always()
        run: |-
          echo "## Formatting Check Summary"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Formatted: ${{ steps.format-check.outputs.formatted || 'N/A' }}"
          echo "- Changes made: ${{ steps.git-check.outputs.changes || 'N/A' }}"
          if [[ "${{ steps.format-check.outputs.formatted }}" == "false" ]]; then
            echo "- Action taken: ${{ github.ref == 'refs/heads/main' && 'PR created' || 'Direct commit' }}"
          fi

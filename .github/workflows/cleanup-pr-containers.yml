---
name: Cleanup PR Containers
on:
  pull_request:
    types: [closed]
jobs:
  cleanup:
    name: Cleanup PR Containers
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write
      issues: write

    # Only run in the base repository, not in forks
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    steps:
      - name: Delete PR container image
        id: delete_pr
        continue-on-error: true
        uses: dataaxiom/ghcr-cleanup-action@ad729defc2c5047d29d4f11ac4a080a493aebd14
        with:
          delete-tags: pr-${{ github.event.pull_request.number }}
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Delete branch container image
        id: delete_branch
        if: ${{ github.event.pull_request.merged == true && github.event.pull_request.head.ref != 'main' }}
        continue-on-error: true
        uses: dataaxiom/ghcr-cleanup-action@ad729defc2c5047d29d4f11ac4a080a493aebd14
        with:
          delete-tags: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Post cleanup summary
        if: ${{ always() }}
        uses: actions/github-script@v7
        env:
          PR_OUTCOME: ${{ steps.delete_pr.outcome }}
          BR_OUTCOME: ${{ steps.delete_branch.outcome }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const {
              number: prNumber,
              head: { ref: branch },
              merged: isMerged,
            } = context.payload.pull_request;
            const { owner, repo } = context.repo;
            // Step outcomes may be 'success' | 'failure' | 'skipped'
            const prOutcome = process.env.PR_OUTCOME;
            const brOutcome = process.env.BR_OUTCOME;
            let body = "ðŸ§¹ **Container Cleanup Summary**\n\n";
            if (isMerged) {
              body += `âœ… **PR  #${prNumber} was merged** â€” we attempted to delete PR and branch containers.\n\n`;
            } else {
              body += `âŒ **PR  #${prNumber} closed without merge** â€” we attempted to delete only the PR container.\n\n`;
            }
            body += "**Cleanup actions taken:**\n";
            body += `- ðŸ—‘ï¸ PR container \`ghcr.io/${owner}/${repo}:pr-${prNumber}\`: **${prOutcome === 'success' ? 'Deleted' : prOutcome === 'failure' ? 'Failed' : 'Skipped'}**\n`;
            if (isMerged && branch !== 'main') {
              body += `- ðŸ—‘ï¸ Branch container \`ghcr.io/${owner}/${repo}:${branch}\`: **${brOutcome === 'success' ? 'Deleted' : brOutcome === 'failure' ? 'Failed' : 'Skipped'}**\n`;
            } else if (isMerged && branch === 'main') {
              body += `- â„¹ï¸ Branch \`main\` container was protected and **not deleted**\n`;
            }
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body,
            });
      - name: Fail if cleanup failed
        if: ${{ always() }}
        shell: bash
        run: |-
          echo "Checking cleanup step outcomes..." >&2
          PR="${{ steps.delete_pr.outcome }}"
          BR="${{ steps.delete_branch.outcome }}"
          FAIL=false
          if [ "$PR" = "failure" ]; then
            echo "::error:: PR container cleanup failed (outcome=$PR)" >&2
            FAIL=true
          fi
          if [ "$BR" = "failure" ]; then
            echo "::error:: Branch container cleanup failed (outcome=$BR)" >&2
            FAIL=true
          fi
          if [ "$FAIL" = true ]; then
            echo "ðŸ›‘ At least one deletion step failed - exiting with failure." >&2
            exit 1
          fi
